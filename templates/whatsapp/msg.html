<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">


<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
*{
    margin:0;
    padding:0;
    box-sizing:border-box;
    font-family: Arial, Helvetica, sans-serif;
}

html,body{
    height:100%;
    overflow:hidden;
    <!-- background-image:url("https://res.cloudinary.com/doik0qtfr/image/upload/v1765756283/file_000000001b0071f58bcbc51e9c9d664d_rnlva3.png"); -->
    background-size: cover;
    background-repeat: no-repeat;
    background-position:center;
    
    
}
.hamburguer{
      position:relative;
      display:block;
      width:100px;
      height:22px;
      background:#fff;
      transition:.3s;
      border-radius:10px;
      margin-top:90px;
      z-index:9999;
    }
    .hamburguer::before,
    .hamburguer::after{
      content:'';
      position:absolute;
      width:100%;
      height:8px;
      background:#fff;
      transition:.3s;
    }
    .hamburguer::before{top:-10px;}
    .hamburguer::after{bottom:-10px;}
    label[for="menu-toggle"] {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 99999;
    }
    strong {
      color: #000;
      font-size:32px;
      z-index:99999;
    }
    nav {
      display: none;
      position: fixed;
      top: 0;
      right: 0;
      width: 100%;
      height: 100vh;
      background: #111;
      padding-top: 100px;
      z-index: 2;
      opacity:70%;
    }
    #menu-toggle:checked ~ nav {
      display: block;
    }
    nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    nav ul li {
      padding: 20px;
      text-align: center;
    }
    nav ul li a {
      color: #fff;
      font-size: 32px;
      text-decoration: none;
    }
    
.chat-container{
    height:100%;
    max-width:420px;
    margin:0 auto;
    display:flex;
    flex-direction:column;
    background:#111;
 
}

/* HEADER */
.chat-header{
    height:55px;
    background:#075e54;
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:bold;
}

/* HEADER */

/* T√çTULO */
.title{
    text-align:center;
    margin:25px 0;
    font-size:20px;
    color:#a78bfa;
}
/* MENSAGENS */
.chat-messages{
    flex:1;
    padding:10px;
    overflow-y:auto;
    display:flex;
    flex-direction:column;
    gap:8px;
}

.bolha{
    max-width:75%;
    padding:8px 12px;
    border-radius:18px;
    font-size:14px;
    display:flex;
    gap:8px;
}

.bolha.enviada{
    align-self:flex-end;
    background:#dcf8c6;
    flex-direction:row-reverse;
}

.bolha.recebida{
    align-self:flex-start;
    background:#fff;
}

.bolha img{
    width:32px;
    height:32px;
    border-radius:50%;
    object-fit:cover;
}

.uid{
    font-size:11px;
    font-weight:bold;
    display:block;
    margin-bottom:2px;
}

/* INPUT */
.chat-input{
    position:relative;
    padding:8px;
    background:#fff;
    border-top:1px solid #ddd;
    display:flex;
    align-items:center;
    gap:8px;
}

.chat-input input[type="text"]{
    flex:1;
    border:none;
    padding:10px 14px;
    border-radius:20px;
    outline:none;
    background:#f0f0f0;
}

.btn-circle{
    width:42px;
    height:42px;
    border-radius:50%;
    border:none;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    color:#fff;
    font-size:18px;
}

.btn-send{ background:#075e54; }
.btn-attach{ background:#25d366; }
#callVideoButton {background:gray;color:#111;}
#callButton {background:red;color:#111;}
#contactButton {background: purple; color:#111;}
.attach-menu{
    position:absolute;
    bottom:60px;
    left:10px;
    display:none;
    flex-direction:column;
    gap:10px;
}

.attach-menu button{
    width:50px;
    height:50px;
    border-radius:50%;
    border:none;
    cursor:pointer;
    font-size:20px;
}
 p{
 	color:#fff;
 }

.btn-img{ background:blue; color:#111; }
.btn-audio{ background:#34b7f1; color:#fff; }

/* PREVIEW ‚Äî ESCONDIDO DE VERDADE */
.image-preview-container{
    display:none;
    padding:10px;
    border-bottom:1px solid #333;
    background:transparent;
    text-align:center;
}

#image-preview{
    max-width:100%;
    max-height:200px;
    display:block;
    margin:0 auto 10px;
}

#remove-image{
    background:#ff4d4d;
    border-radius:50%;
    width:50px;
    height:50px;
    color:#fff;
    border:none;
    cursor:pointer;
    display:block;
    margin:0 auto;
}


input[type="file"]{ display:none; }

@media(max-width:600px){
    .chat-container{ max-width:100%; }
}
</style>
</head>

<body>

    
 

<div class="chat-container">
    <div class="chat-header">WhatsApp Restrito</div>





    <div class="chat-messages" id="mensagens"></div>
     <!-- PREVIEW -->
    <div class="image-preview-container" id="image-preview-container">
        <img id="image-preview" src="">
        <button id="remove-image" ><i class="fas fa-close"></i></button>
    </div>
    <div class="chat-input">

        <div class="attach-menu" id="attachMenu">
             <button class="btn-img" onclick="document.getElementById('uploadImg').click()"><i class="fa-solid fa-camera"></i></button>
             <button id="startButton"><i class="fas fa-microphone"></i></button>
             <button id="callButton" disabled><i class="fas fa-phone"></i></button>
             <button id="callStopButton" disabled style="display:none;"><i class="fas fa-phone-slash"></i></button>
             <button id="contactButton" disabled>
               <a href="/contatos/users/{{ user_id }}" style="all: unset; cursor: pointer;">
                 <i class="fas fa-user"></i>
               </a>
             </button>

             <button id="MensagensRecebidasButton" disabled>
             <a href="/msg/recebida/{{ user_id }}" style="all: unset; cursor: pointer;">
             <i class="fas fa-user"></i>
             </a>
             </button>

             <button id="callVideoButton" disabled>
              <a href="/chamada/video/{{ user_id }}" style="all: unset; cursor: pointer;">
              <i class="fas fa-video"></i>
              </a>
             </button>
             <p id="status">Status: Pronto</p>
             <p>URL do √°udio: <a id="audioUrl" href="#" target="_blank"></a></p>
        </div>

        <button class="btn-circle btn-attach" onclick="toggleAttach()">üìé</button>
        <input type="file" id="uploadImg" accept="image/*">

        <input type="text" id="mensagemInput" placeholder="Mensagem">
        <button class="btn-circle btn-send" onclick="enviarMensagem()">‚û§</button>
    </div>
</div>

<script>
var socket = io();

// ====================== MENU DE ANEXOS ======================
function toggleAttach(){
    const menu = document.getElementById('attachMenu');
    menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
}

// ====================== MENSAGENS ======================
function enviarMensagem(){
    const input = document.getElementById('mensagemInput');
    if(!input.value.trim()) return;
    socket.emit('enviar_mensagem_frontend', { texto: input.value, user_id: "User" });
    input.value = '';
}

socket.on('receber_mensagem_backend', data => {
    const box = document.getElementById('mensagens');
    const div = document.createElement('div');
    div.className = 'bolha ' + (data.tipo || 'recebida');
    const img = document.createElement('img');
    img.src = `/upload/${data.user_id}`;
    img.onerror = () => img.src = 'https://res.cloudinary.com/doik0qtfr/image/upload/v1765756283/file_000000001b0071f58bcbc51e9c9d664d_rnlva3.png';
    const texto = document.createElement('div');
    texto.innerHTML = `<span class="uid">${data.user_id}</span>${data.texto}`;
    div.append(img, texto);
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
});

// ====================== √ÅUDIO ======================
const startButton = document.getElementById('startButton');
const stopButton = document.getElementById('stopButton');
const status = document.getElementById('status');
const audioUrl = document.getElementById('audioUrl');
let mediaRecorder;
let audioChunks = [];

startButton.addEventListener('click', async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const reader = new FileReader();
        reader.readAsDataURL(audioBlob);
        reader.onloadend = () => {
            socket.emit('upload_audio', { audio: reader.result });
        };
        audioChunks = [];
    };
    mediaRecorder.start();
    status.textContent = 'Status: Gravando...';
    startButton.disabled = true;
    stopButton.disabled = false;
});

stopButton.addEventListener('click', () => {
    mediaRecorder.stop();
    status.textContent = 'Status: Parando grava√ß√£o...';
    startButton.disabled = false;
    stopButton.disabled = true;
});

// ====================== STATUS DO UPLOAD ======================
socket.on('connect', () => status.textContent = 'Status: Conectado ao servidor');
socket.on('upload_complete', data => {
    status.textContent = 'Status: Upload conclu√≠do!';
    audioUrl.href = data.url;
    audioUrl.textContent = data.url;
});
socket.on('upload_error', data => status.textContent = `Status: Erro no upload - ${data.error}`);
</script>

<script>
  
  const usersList = document.getElementById("users-list");

  socket.emit("join_users", { user_id: "{{ user_id }}" });

  socket.on("user_conectado", (data) => {
    const div = document.createElement("div");
    div.textContent = `üë§ ${data.user_id} |üë§${data.nome}| |üåç ${data.cidade} üí∞ ${data.balance}`;
    usersList.prepend(div);
  });


  /* PREVIEW IMG */
  const fileInput = document.getElementById('uploadImg');
  const imagePreview = document.getElementById('image-preview');
  const previewContainer = document.getElementById('image-preview-container');
  const removeImageButton = document.getElementById('remove-image');
  
  fileInput.addEventListener('change',()=>{
      const file = fileInput.files[0];
      if(!file || !file.type.startsWith('image/')) return;
  
      const reader = new FileReader();
      reader.onload = e=>{
          imagePreview.src = e.target.result;
          previewContainer.style.display='block';
      };
      reader.readAsDataURL(file);
  });
  
  removeImageButton.addEventListener('click',()=>{
      imagePreview.src='';
      previewContainer.style.display='none';
      fileInput.value='';
  });
  
</script>
</body>
</html>



