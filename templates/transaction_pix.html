<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAV AWARDS | Pix</title>
    <style>
    body{
    	overflow:hidden;
    }
  
   
   
   .pix-logo{
       display:flex;
       justify-content:center;
       margin:6px 0 14px;
   }
   
   
   
    </style>

    <!-- SOCKET.IO CDN -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/transaction_pix.css') }}">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>

<body>

<header>
    <div class="logo">
        <a href="#">
      <img src="https://res.cloudinary.com/doik0qtfr/image/upload/v1765756283/file_000000001b0071f58bcbc51e9c9d664d_rnlva3.png" alt="Logo do sistema">

        </a>
    </div>
</header>

<main>
    <div class="pix-container">
        <div class="payment">

            <div id="notifications"></div>

            <p>Abra seu aplicativo de pagamento e escolha <b>Ler QR Code</b></p>
            <span>Aponte a câmera do seu celular</span>

            <div class="qrcode-info">
                <img src="https://res.cloudinary.com/dptprh0xk/image/upload/v1764290948/cellphone-icon_remhjc.svg" draggable="false">
            </div>

            <div class="qrcode">
                <img src="{{ qrcode }}" alt="QR CODE">
            </div>
            <div class="pix-value">
             <strong>FERRARI GAMES ITECH IO</strong>
             </div>
           

            <div class="pix-value">
                <strong>{{ valor }}</strong>
            </div>

            <div class="pix-value">
                <strong>{{ payment_id }}</strong>
            </div>

            
            
            
            <div id="copy-mobile" class="pix-copy-mobile">
                <img src="https://res.cloudinary.com/dptprh0xk/image/upload/v1764290949/copy-icon_z8ur77.svg" draggable="false">
                <span>Copiar código</span>
            </div>

            <div class="pix-copy-and-past">
                <span>Você também pode pagar usando <b>Pix Copia e Cola</b>. Copie o código abaixo:</span>
                <div class="qrcode-text">
                    <img id="copy" src="https://res.cloudinary.com/dptprh0xk/image/upload/v1764290949/copy-icon_z8ur77.svg" draggable="false">
                    <div id="copied-code">Código copiado.</div>
                    <p id="qrcode-text">{{ qr_code_cola }}</p>
                </div>
            </div>

        </div>
    </div>
</main>


<script src="{{ url_for('static', filename='js/see-tickets.js') }}"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const copyBtn = document.getElementById("copy");
    const copyMobileBtn = document.getElementById("copy-mobile");
    const qrcodeText = document.getElementById("qrcode-text");
    const copiedCodeBox = document.getElementById("copied-code");

    function copiarPix() {
        const text = qrcodeText.textContent.trim();
        if (!text) return;

        // COPY FORÇADO
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);

        // MENSAGEM FORÇADA (IGNORA CSS)
        copiedCodeBox.textContent = "Código copiado!";
        copiedCodeBox.style.setProperty("display", "block", "important");
        copiedCodeBox.style.setProperty("visibility", "visible", "important");
        copiedCodeBox.style.setProperty("opacity", "1", "important");
        copiedCodeBox.style.setProperty("position", "relative", "important");
        copiedCodeBox.style.setProperty("z-index", "99999", "important");
        copiedCodeBox.style.background = "#16a34a";
        copiedCodeBox.style.color = "#fff";
        copiedCodeBox.style.padding = "8px 12px";
        copiedCodeBox.style.borderRadius = "6px";
        copiedCodeBox.style.marginTop = "8px";
        copiedCodeBox.style.fontWeight = "bold";

        setTimeout(() => {
            copiedCodeBox.style.opacity = "0";
        }, 1500);
    }

    copyBtn.addEventListener("click", copiarPix);
    copyMobileBtn.addEventListener("click", copiarPix);
});


// ===== SOCKET.IO =====
var paymentId = "{{ payment_id }}";
var userId = "{{ user_id }}";
var socket = io(window.location.origin);

socket.on("connect", function () {
    socket.emit("join_payment", { payment_id: paymentId });
});

socket.on("payment_update", async function (data) {
    if (data.payment_id !== paymentId) return;

    var div = document.getElementById("notifications");
    var p = document.createElement("p");

    if (data.status === "approved") {
        p.style.color = "green";
        p.innerText = "✅ Pagamento aprovado!";
        div.innerHTML = "";
        div.appendChild(p);


        setTimeout(function () {
            window.location.href = `/index/users/${userId}`;
        }, 3000);

    } else {
        p.style.color = "red";
        p.innerText = "❌ Pagamento recusado!";
        div.innerHTML = "";
        div.appendChild(p);

        setTimeout(function () {
            window.location.href = `/compra/recusada/${userId}`;
        }, 3000);
    }
});
</script>

</body>
</html>
