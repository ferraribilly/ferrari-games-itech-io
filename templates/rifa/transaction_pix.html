<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAV AWARDS | Pix</title>
    <style>
    .see-tickets {
        display: flex;
        justify-content: center;
        font-size: 17px;
        font-weight: 500;
        text-transform: uppercase;
        color: #373737;
        border-radius: 7px;
        cursor: pointer;
        user-select: none;
        padding: 12px;
        margin-top: 12px;
        transition: all 0.2s;
    }
    
    .see-tickets:hover {
        background-color: #f3f3f3;
        color: #000000;
        border-radius: 9px 9px 25px 25px;
        transition: all 0.2s;
    }
    
    .ticket-numbers {
        opacity: 0;
        visibility: hidden;
        height: 0;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        transition: margin 0.4s;
    }
    
    .ticket-numbers p {
        font-size: 15px;
        color: #474747;
        border: 1px solid #6f6f6f;
        border-radius: 7px;
        min-width: 44px;
        text-align: center;
        text-align: -webkit-center;
        padding: 8px;
        margin: 0 5px 5px 0;
    }
    
    .ticket-numbers p:last-child {
        margin-right: 0;
    }
    
    .visible {
        height: max-content;
        visibility: visible;
        opacity: 1;
        margin: 28px 22px;
        transition: all 0.4s;
    }
    </style>

    <!-- SOCKET.IO CDN -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/transaction_pix.css') }}">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
</head>

<body>

<header>
    <div class="logo">
        <a href="#">
      <img src="https://res.cloudinary.com/doik0qtfr/image/upload/v1765756283/file_000000001b0071f58bcbc51e9c9d664d_rnlva3.png" alt="Logo do sistema">

        </a>
    </div>
</header>

<main>
    <div class="pix-container">
        <div class="payment">

            <div id="notifications"></div>

            <p>Abra seu aplicativo de pagamento e escolha <b>Ler QR Code</b></p>
            <span>Aponte a câmera do seu celular</span>

            <div class="qrcode-info">
                <img src="https://res.cloudinary.com/dptprh0xk/image/upload/v1764290948/cellphone-icon_remhjc.svg" draggable="false">
            </div>

            <div class="qrcode">
                <img src="{{ qrcode }}" alt="QR CODE">
            </div>

            <div class="pix-value">
                <strong>SAV AWARDS</strong>
            </div>

            <div class="pix-value">
                <span>Valor do Pix:</span>
                <strong>{{ valor }}</strong>
            </div>

            <div class="pix-value">
                <span>Descrição:</span>
                <strong>{{ description }}</strong>
            </div>

            <div class="pix-value">
             <span>Quantidade:</span>
             <strong>{{ quantity }}</strong>
             </div>
            
             <div id="see-tickets" class="see-tickets">
             <span>Meus Bilhetes</span>
             </div>

            <div id="ticket-numbers" class="ticket-numbers">
             {% for t in tickets %}
             <p>{{ t }}</p>
              {% endfor %}
             </div>

            <div id="copy-mobile" class="pix-copy-mobile">
                <img src="https://res.cloudinary.com/dptprh0xk/image/upload/v1764290949/copy-icon_z8ur77.svg" draggable="false">
                <span>Copiar código</span>
            </div>

            <div class="pix-copy-and-past">
                <span>Você também pode pagar usando <b>Pix Copia e Cola</b>. Copie o código abaixo:</span>
                <div class="qrcode-text">
                    <img id="copy" src="https://res.cloudinary.com/dptprh0xk/image/upload/v1764290949/copy-icon_z8ur77.svg" draggable="false">
                    <div id="copied-code">Código copiado.</div>
                    <p id="qrcode-text">{{ qr_code_cola }}</p>
                </div>
            </div>

        </div>
    </div>
</main>
<script src="{{ url_for('static', filename='js/see-tickets.js') }}"></script>

<script>
// ===== COPIAR PIX =====
document.getElementById('copy').addEventListener('click', copyText);
document.getElementById('copy-mobile').addEventListener('click', copyText);

function copyText() {
    var qrcodeText = document.getElementById('qrcode-text');
    var copiedCodeBox = document.getElementById('copied-code');

    navigator.clipboard.writeText(qrcodeText.textContent).then(function () {
        qrcodeText.style.filter = 'blur(1px)';
        copiedCodeBox.style.visibility = 'visible';
        copiedCodeBox.style.opacity = '0.9';
        copiedCodeBox.style.transition = 'all 0.3s';

        setTimeout(function () {
            qrcodeText.style.filter = '';
            copiedCodeBox.style.visibility = '';
            copiedCodeBox.style.opacity = '';
        }, 1000);
    });
}

// ===== SOCKET.IO =====
var paymentId = "{{ payment_id }}";
var userId = "{{ user_id }}";
var socket = io(window.location.origin);

socket.on("connect", function () {
    socket.emit("join_payment", { payment_id: paymentId });
});

socket.on("payment_update", async function (data) {
    if (data.payment_id !== paymentId) return;

    var div = document.getElementById("notifications");
    var p = document.createElement("p");

    if (data.status === "approved") {
        p.style.color = "green";
        p.innerText = "✅ Pagamento aprovado!";
        div.innerHTML = "";
        div.appendChild(p);


        setTimeout(function () {
            window.location.href = `/index/users/${userId}`;
        }, 3000);

    } else {
        p.style.color = "red";
        p.innerText = "❌ Pagamento recusado!";
        div.innerHTML = "";
        div.appendChild(p);

        setTimeout(function () {
            window.location.href = `/compra/recusada/${userId}`;
        }, 3000);
    }
});
</script>

</body>
</html>
